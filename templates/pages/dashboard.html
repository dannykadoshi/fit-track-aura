{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - FitTrack Aura{% endblock %}

{% block extra_css %}
<style>
    /* Progress Bar Styles for Dashboard */
    .progress-custom {
        width: 100%;
        height: 8px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 1rem;
        overflow: hidden;
        position: relative;
        margin-top: 8px;
    }
    
    .progress-bar-custom {
        height: 100%;
        background: linear-gradient(90deg, #a855f7, #ec4899);
        border-radius: 1rem;
        transition: width 0.3s ease;
        position: relative;
    }
    
    .progress-bar-custom::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, 
            rgba(255, 255, 255, 0.2) 0%, 
            rgba(255, 255, 255, 0) 50%, 
            rgba(255, 255, 255, 0.2) 100%
        );
        animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }
    
    /* Green when 100% complete */
    .progress-bar-custom[style*="100%"] {
        background: linear-gradient(90deg, #22c55e, #16a34a) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Welcome Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center flex-wrap">
                <div class="mb-3 mb-md-0">
                    <h1 class="display-5 fw-bold text-white">Welcome back, {{ user.username }}! üëã</h1>
                    <p class="text-muted">Here's your fitness summary for today</p>
                </div>
                <div class="badge badge-custom">
                    <span style="font-size: 1.5rem;">
                        {% if current_streak > 0 %}üî•{% else %}üìÖ{% endif %}
                    </span>
                    <div class="ms-2">
                        <div class="fw-bold">{{ current_streak }} {% if current_streak == 1 %}Day{% else %}Days{% endif %}</div>
                        <small>Current Streak</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Best Streak Achievement Badge -->
    {% if best_streak >= 3 %}
    <div class="alert alert-warning mb-4" role="alert">
        <div class="d-flex align-items-center">
            <div class="fs-2 me-3">
                {% if best_streak >= 30 %}
                    üèÖ
                {% elif best_streak >= 14 %}
                    ü•á
                {% elif best_streak >= 7 %}
                    ü•à
                {% else %}
                    ü•â
                {% endif %}
            </div>
            <div>
                <h5 class="alert-heading mb-1">Achievement Unlocked!</h5>
                <p class="mb-0">
                    Your best streak is <strong>{{ best_streak }} days</strong>! 
                    {% if best_streak >= 30 %}
                        You're a fitness legend! üî•
                    {% elif best_streak >= 14 %}
                        Two weeks strong! Keep going! üí™
                    {% elif best_streak >= 7 %}
                        One week streak! Awesome! ‚≠ê
                    {% else %}
                        Great start! Keep building! üéØ
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Stats Overview -->
    <div class="dashboard-grid mb-5">
        <!-- Stat 1 - Workouts This Month -->
        <div class="stat-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="stat-icon">üèãÔ∏è‚Äç‚ôÇÔ∏è</div>
                <span class="text-success fw-semibold">This Month</span>
            </div>
            <h3 class="fw-bold mb-1">{{ workouts_this_month }}</h3>
            <p class="text-muted mb-0">Workouts Logged</p>
        </div>

        <!-- Stat 2 - Current Streak -->
        <div class="stat-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    {% if current_streak >= 7 %}
                        üèÜ
                    {% elif current_streak >= 3 %}
                        ‚≠ê
                    {% else %}
                        üî•
                    {% endif %}
                </div>
                <span class="{% if current_streak > 0 %}text-success{% else %}text-muted{% endif %} fw-semibold">
                    {% if current_streak == 0 %}
                        Start Today!
                    {% elif current_streak >= 7 %}
                        On Fire!
                    {% else %}
                        Keep Going!
                    {% endif %}
                </span>
            </div>
            <h3 class="fw-bold mb-1">{{ current_streak }} {% if current_streak == 1 %}Day{% else %}Days{% endif %}</h3>
            <p class="text-muted mb-0">Current Streak</p>
        </div>

        <!-- Stat 3 - Total Training Time -->
        <div class="stat-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="stat-icon" style="background: linear-gradient(135deg, #10b981, #059669);">‚è±Ô∏è</div>
                <span class="text-success fw-semibold">This Month</span>
            </div>
            <h3 class="fw-bold mb-1">{{ total_time }}</h3>
            <p class="text-muted mb-0">Minutes Trained</p>
        </div>

        <!-- Stat 4 - Goals Progress -->
        <div class="stat-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b, #dc2626);">üéØ</div>
                <span class="{% if goals_count > 0 %}text-warning{% else %}text-muted{% endif %} fw-semibold">
                    {% if goals_count == 0 %}
                        Set Goals
                    {% elif goals_count == 1 %}
                        1 Active Goal
                    {% else %}
                        {{ goals_count }} Active Goals
                    {% endif %}
                </span>
            </div>
            <h3 class="fw-bold mb-1">
                {% if goals_count > 0 %}
                    {{ goals_progress }}%
                {% else %}
                    ‚Äî
                {% endif %}
            </h3>
            <p class="text-muted mb-0">Goals Progress</p>
        </div>
    </div>

    <!-- Achievement Badges Preview -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card-custom p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="fw-bold text-white mb-0">üèÜ Achievements</h3>
                    <a href="{% url 'badges' %}" class="btn btn-sm btn-outline-light">View All</a>
                </div>
                
                {% if user.badges.exists %}
                    <div class="d-flex gap-3 flex-wrap">
                        {% for badge in user.badges.all|slice:":5" %}
                            <div class="text-center" title="{{ badge.badge_name }}">
                                <div class="stat-icon" style="width: 60px; height: 60px; font-size: 2rem;">
                                    {{ badge.badge_icon }}
                                </div>
                                <small class="text-muted d-block mt-1">{{ badge.badge_name }}</small>
                            </div>
                        {% endfor %}
                        {% if user.badges.count > 5 %}
                            <div class="text-center">
                                <a href="{% url 'badges' %}" class="stat-icon d-flex align-items-center justify-content-center" style="width: 60px; height: 60px; font-size: 1.5rem; background: rgba(255,255,255,0.1);">
                                    +{{ user.badges.count|add:"-5" }}
                                </a>
                                <small class="text-muted d-block mt-1">More</small>
                            </div>
                        {% endif %}
                    </div>
                {% else %}
                    <p class="text-muted mb-0">Complete workouts and goals to earn achievement badges! üéØ</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Weekly Activity Chart -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card-custom p-4">
                <h3 class="fw-bold text-white mb-4">üìà Weekly Activity</h3>
                
                {% if weekly_total > 0 %}
                    <div class="chart-container" style="position: relative; height: 300px;">
                        <canvas id="weeklyActivityChart"></canvas>
                    </div>
                    
                    <div class="row mt-4 text-center">
                        <div class="col-md-4 mb-3">
                            <div class="stat-icon mx-auto mb-2" style="width: 40px; height: 40px; font-size: 1.5rem;">üí™</div>
                            <h5 class="fw-bold text-white mb-0">{{ weekly_total }}</h5>
                            <small class="text-muted">Total Minutes</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="stat-icon mx-auto mb-2" style="width: 40px; height: 40px; font-size: 1.5rem;">üìä</div>
                            <h5 class="fw-bold text-white mb-0">{{ weekly_average }}</h5>
                            <small class="text-muted">Avg Per Day</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="stat-icon mx-auto mb-2" style="width: 40px; height: 40px; font-size: 1.5rem;">üî•</div>
                            <h5 class="fw-bold text-white mb-0">{{ most_active_day }}</h5>
                            <small class="text-muted">Most Active ({{ max_day_duration }} min)</small>
                        </div>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <div class="stat-icon mx-auto mb-3" style="width: 64px; height: 64px; font-size: 2.5rem;">üìà</div>
                        <h5 class="text-white mb-2">No activity this week yet</h5>
                        <p class="text-muted mb-4">Start logging workouts to see your weekly progress!</p>
                        <a href="{% url 'workout_create' %}" class="btn btn-gradient-purple">Log Your First Workout</a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="row g-4">
        <!-- Recent Workouts -->
        <div class="col-lg-8">
            <div class="card-custom p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="fw-bold mb-0">Recent Workouts</h3>
                    <a href="{% url 'workout_create' %}" class="btn btn-sm btn-gradient-purple">
                        <span>‚ûï</span> Log Workout
                    </a>
                </div>

                {% if recent_workouts %}
                    <div class="space-y-3">
                        {% for workout in recent_workouts %}
                            <div class="workout-card">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="d-flex align-items-start gap-3">
                                        <div class="stat-icon" style="width: 40px; height: 40px; font-size: 1.2rem;">
                                            üèãÔ∏è
                                        </div>
                                        <div>
                                            <h5 class="fw-semibold text-white mb-1">{{ workout.title }}</h5>
                                            <p class="text-muted mb-0 small">
                                                {{ workout.date|date:"M d, Y" }} ‚Ä¢ 
                                                {% if workout.duration %}{{ workout.duration }} min{% endif %}
                                                {% if workout.total_exercises %} ‚Ä¢ {{ workout.total_exercises }} exercises{% endif %}
                                            </p>
                                        </div>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <a href="{% url 'workout_update' workout.pk %}" class="btn btn-sm btn-outline-light">Edit</a>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <div class="stat-icon mx-auto mb-3" style="width: 64px; height: 64px; font-size: 2rem;">üèãÔ∏è</div>
                        <h5 class="text-white mb-2">No workouts yet</h5>
                        <p class="text-muted mb-4">Start tracking your fitness journey today!</p>
                        <a href="{% url 'workout_create' %}" class="btn btn-gradient-purple">Log Your First Workout</a>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Active Goals -->
        <div class="col-lg-4">
            <div class="card-custom p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="fw-bold mb-0">Active Goals</h3>
                    <a href="{% url 'goal_list' %}" class="text-purple-400 text-decoration-none small fw-semibold">Manage ‚Üí</a>
                </div>

                {% if active_goals %}
                    <div class="space-y-3">
                        {% for goal in active_goals %}
                            <div class="card-custom p-3 mb-3">
                                <div class="d-flex align-items-start justify-content-between mb-2">
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center gap-2 mb-2">
                                            <span style="color: var(--purple-500);">
                                                {% if goal.is_completed %}‚úÖ{% else %}‚≠ï{% endif %}
                                            </span>
                                            <h6 class="fw-semibold text-white mb-0 small">{{ goal.title }}</h6>
                                        </div>
                                        <p class="text-muted mb-0 small">
                                            {{ goal.current_display }} out of {{ goal.target_display }} {{ goal.get_unit_display }} ‚Ä¢ 
                                            Due {{ goal.target_date|date:"M d" }}
                                        </p>
                                    </div>
                                    <span class="fw-bold" style="color: {% if goal.progress >= 100 %}#22c55e{% else %}#a855f7{% endif %}">{{ goal.progress }}%</span>
                                </div>
                                <!-- Progress Bar -->
                                <div class="progress-custom">
                                    <div class="progress-bar-custom" style="width: {{ goal.progress }}%;"></div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <div class="stat-icon mx-auto mb-3" style="width: 48px; height: 48px;">üéØ</div>
                        <h6 class="text-white mb-2">No goals set</h6>
                        <p class="text-muted small mb-3">Set goals to stay motivated!</p>
                        <a href="{% url 'goal_create' %}" class="btn btn-sm btn-gradient-purple">Create Goal</a>
                    </div>
                {% endif %}
            </div>

            <!-- Streak Stats -->
            <div class="card-custom p-4 mt-4">
                <h5 class="fw-bold mb-3">Streak Stats</h5>
                <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom border-secondary">
                    <span class="text-muted">Current Streak</span>
                    <span class="fw-bold text-white">{{ current_streak }} days üî•</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom border-secondary">
                    <span class="text-muted">Best Streak</span>
                    <span class="fw-bold text-white">{{ best_streak }} days üèÜ</span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <span class="text-muted">Total Workouts</span>
                    <span class="fw-bold text-white">{{ workouts_count }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
{% if weekly_total > 0 %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    const ctx = document.getElementById('weeklyActivityChart').getContext('2d');
    
    const weeklyActivityChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: {{ week_labels|safe }},
            datasets: [{
                label: 'Minutes',
                data: {{ week_data|safe }},
                backgroundColor: 'rgba(168, 85, 247, 0.8)',
                borderColor: 'rgba(168, 85, 247, 1)',
                borderWidth: 2,
                borderRadius: 8,
                hoverBackgroundColor: 'rgba(236, 72, 153, 0.9)',
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(15, 23, 42, 0.9)',
                    titleColor: '#fff',
                    bodyColor: '#e2e8f0',
                    borderColor: 'rgba(168, 85, 247, 0.5)',
                    borderWidth: 1,
                    padding: 12,
                    displayColors: false,
                    callbacks: {
                        label: function(context) {
                            return context.parsed.y + ' minutes';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#94a3b8',
                        callback: function(value) {
                            return value + ' min';
                        }
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)',
                        drawBorder: false
                    }
                },
                x: {
                    ticks: {
                        color: '#94a3b8'
                    },
                    grid: {
                        display: false
                    }
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeInOutQuart'
            }
        }
    });
</script>
{% endif %}
{% endblock %}
{% endblock %}
